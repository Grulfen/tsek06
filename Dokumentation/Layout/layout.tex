
\documentclass[a4paper,12pt]{article} \usepackage{graphicx}
\usepackage{epstopdf} %\usepackage{gensymb} \usepackage{longtable}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{morefloats}
\lstset{
        language=verilog,
        basicstyle=\footnotesize,
        breaklines=true
}

\input{../LIPS.tex}

\newcommand{\degree}{\ensuremath{^\circ}}
\newcommand{\LIPSartaltermin}{2013/VT}
\newcommand{\LIPSkursnamn}{TSEK06}
\newcommand{\LIPSprojekttitel}{DLL Based Frequency Multiplier}

\newcommand{\LIPSprojektgrupp}{Group 7}

\newcommand{\LIPSgruppepost}{}
\newcommand{\LIPSgrupphemsida}{} 
\newcommand{\LIPSdokumentansvarig}{Gustav Svensk}

\newcommand{\LIPSkund}{ISY, Linköpings universitet, 581\,83 Linköping}

\newcommand{\LIPSkundkontakt}{Amin Ojani}
\newcommand{\LIPSkursansvarig}{Atila Alvandpour}
\newcommand{\LIPShandledare}{Amin Ojani}

\newcommand{\LIPSdokumenttyp}{Layout Design} 
\newcommand{\LIPSredaktor}{Nora Björklund} 
\newcommand{\LIPSversion}{1.0} 
\newcommand{\LIPSdatum}{\dagensdatum}

\newcommand{\LIPSgranskare}{} 
\newcommand{\LIPSgranskatdatum}{}
\newcommand{\LIPSgodkannare}{} 
\newcommand{\LIPSgodkantdatum}{}

\begin{document}
\LIPStitelsida

%% Argument till \LIPSgruppmedlem: namn, roll i gruppen, telefonnummer, epost
\selectlanguage{swedish}
\begin{LIPSprojektidentitet}
 
\LIPSgruppmedlem{Nora Björklund}{Project leader}{076 7756
789}{norbj648@student.liu.se}
\LIPSgruppmedlem{\LIPSdokumentansvarig}{Documentation}{073
6208776}{grulfen3@gmail.com} 
\LIPSgruppmedlem{Christopher Hallberg}{}{0739845945}{chrha007@student.liu.se} 
\LIPSgruppmedlem{Gustaf Bengtz}{}{0707367307}{gbengtz@gmail.com} 
\LIPSgruppmedlem{Johan Berneland}{}{0704988329}{johbe915@student.liu.se}
\end{LIPSprojektidentitet}

\selectlanguage{english}

\tableofcontents{} 
\newpage %% Argument till \LIPSversionsinfo: versionsnummer, datum, Ändringar,
         %  utfört av,granskat av
\addcontentsline{toc}{section}{Document history}
\begin{LIPSdokumenthistorik} 
        \LIPSversionsinfo{0.1}{}{First draft.}{}{}
\end{LIPSdokumenthistorik} 
\newpage

\section{Time Report}
% Bifogas

\section{Project Desciption}
% Kort beskrivning med motivering och mål.
% Blocknivå beskrivning liknande från tidigare rapporter

The complete system

\begin{figure}[h]
\centering
\includegraphics[width=\textwidth]{../Bilder/Layout/complete_system_pad.png}
\caption{Complete system}
\label{fig:complete_system_pad}
\end{figure}

\subsection{Phase Detector}
The Phase Detector (PD) is used check whether the 360\degree delayed
signal has got a rising edge before or after the system clock. If the
360\degree delayed clock rises before the system clock, the output
from the PD is 0, and if it rises after the system clock the output is 1.
This is used to tell the counter whether it should count up or down. 

The final layout of the PD can be seen in \ref{fig:pd_final} in appendix \ref{sec:Layout}.
\subsection{Counter}
The purpose of the counter is to generate the control signals for the delay line.
The counter is a six bit up/down counter with synchronous reset and both
inverted and non-inverted outputs. It is controlled by two signals, an enable
signal which is generated by the lock detector and an up/down signal generated
by the phase detector. It is made up of six bitcells (that can be seen in figure \ref{fig:bitcell_final}) and a small logical net to
manage the enable and up/down signal.

For a more detailed description of the function of the counter see the transistor report \cite{transistor} 

During the layout of the counter the aim has been to minimize the on-chip area.This has resulted in a compact layout as can be seen in figure \ref{fig:counter_final}.

\subsection{Digitally Controlled Delay Line}
\label{sec:del}
The Digitally Controlled Delay Line, henceforth called delay line, is the part
that delays the input clock signal. The delay line is divided into eight
identical blocks connected in series. Each block delays the signal $45\degree$
giving a total delay of 360\degree. The blocks in turn consists of a two step
buffers and NMOS transistors working as variable capacitors. The capacitors are
controlled by the counter. For more details see the transistor level report
\cite{transistor}.

For the layout all transistor sizes in the delay line had to be changed because
of added resistance and parasitic capacitances. With the sizes derived in the
schematic the delay line gave too much delay, making it impossible to reach the
desired operating frequency interval. In order to reduce the static delay the
buffer sizes in the delay cells was increased. However, while reducing the
static delay, this also caused interval to become smaller. Therefore the sizes
of the NMOS capacitors had to be increased.

A separate VDD was added to the delay line in order to be able to compensate for
process variations. A higher voltage would make the overall delay smaller and a
lower voltage could increase the delay.

When routing the interconnects within the delay line it is important to keep the
length of the wires between the blocks equal. The distance from the delay line
to the frequency multiplier also needs to be the same for all output signals.
Furthermore, because the last output signal also is fed back to the phase and
lock detectors, dummy transistors are placed on the lower seven output signals
to obtain an equal load.

The finished layout of the delay line is shown in figure \ref{fig:delay_final}.

\subsection{Lock Detector}
% Hänvisa till tidigare beskrivning på lockdetektorn
To dampen and prevent jitter effects and to save power a lock detector
has been implemented. As described in both the high level and the
transistor level report the lock detector takes two signals and if
the delay between them are within a certain interval the output is
low, otherwise high. The layout can be seen in appendix \ref{sec:layout} in figure \ref{fig:LD}.
\subsection{Frequency Multiplier}
The frequency multiplier takes the eight delayed signals from the delay line and
combines them to a signal with four times the frequency of the original input
signal. A more detailed description can be seen in the transistor level report\cite{transistor}.

When the interconnects were laid out, the length and metal layer was considered
to achieve the same delay on all relevant signals. This was especially important
in this block and the interconnects from the delay line to this block due to
the precise timings. The layout of the frequency multiplier can be seen in
figure \ref{fig:freq_mult_final} in appendix \ref{sec:Layout}.


\section{Simulation Result}
% Testresultat, typiska tester. Med PAD-frame och allt
In this section the simulation result of the system and its subsystem will be
presented.

\subsection{Whole System Simulation}
The simulations of the system, in the different corners, worked well. A multiplication
of four could be reached in all corners, after a little tweaking of the voltage-levels.
The system did not manage to work at an input of 250 MHz in all corners.

The system managed to obtain an output frequency of 1 GHz for most cases. The ones that
did not reach the goal, but obtained an output frequency of roughly 800 MHz were:

\begin{tabular}{l l l}
Corner & Temperature & Frequency\\ \hline
ws & 40\degree & 800 MHz\\
tm & 100\degree & 880 MHz
\end{tabular}

A simulation of the system can be viewed in Figure \ref{fig:sim_system}
\begin{figure}[h]
\centering
\includegraphics[width=\textwidth]{../Bilder/Layout/simulation_system.png}
\caption{Simulation of the system}
\label{fig:sim_system}
\end{figure}

If the corner simulated was ws, the voltage for the frequency multiplier
needed to be adjusted, and the input clock frequency had to be lowered 
to 200 MHz resulting in an output of 800 MHz instead of the desired 1 GHz.

On the other hand we managed to obtain an output of a little more than 1 GHz for
the 40\degree simulation of the tm corner, where we could successfully use an 
input clock with a period of 3.8ns.
Also, the voltage of the frequency multiplier could be reduced when the corner simulated was wp.

\subsubsection{Temperature simulations}
The system works well for 40\degree C in all corners except ws.
When the temperature is increased to 100\degree C we had to decrease 
the input clock in order to make the system multiply the frequency
by four.

\subsubsection{Power usage}
The power usage, when the system is simulated at 40\degree C.

\begin{tabular}{ l | l }
Part & Power consumption [mW] \\
\hline
Delay Line & 6.38 \\
Frequency multiplier & 25.61 \\
Buffers & 90.12 \\
The rest & 18.34 \\ \hline
Total chip with buffers & 140.5 \\
Total chip without buffers & 50.33
\end{tabular}

\subsection{Phase Detector}
The most interesting aspect of the PD is the time needed for the PD to set-up.
 The set-up time is how long before the rising edge of the clock that the data
 needs to arrive to be sure to be noted by the PD this clock-period. The set-up
 time for the corners can be seen below.
 
\begin{tabular}{l l}
tm & 144 ps \\
wo & 178 ps \\
wz & 108 ps \\
wp & 84 ps \\
ws & 210 ps
\end{tabular}

The reason as to why this value differ such a great deal, when compared 
to the simulation from the transistor level is due to the fact that the 
clock we compare the 360\degree delay signal to is a different one.
The clock used to compare in the layout simulation is the internal clock, while 
we compared the 360\degree delay signal to the external clock in the transistor level.

The plotted results of the corners can be viewed in appendix \ref{sec:corners}

\subsection{Counter}

\subsection{Digitally Controlled Delay Line}
As mentioned in the description of the delay line in section \ref{sec:del} all
transistor sizes had to be changed in the layout. There are two important aspects of
the functionality of the delay line. The first being the frequency range of the input
for which a successful lock can be obtained. The second is the resolution,
meaning the sizes of the steps when changing the delay. Figure \ref{fig:del_bit}
shows the delay obtained for each bit in a typical mean simulation performed in
40\degree.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{../Bilder/Layout/simulations/delayCMOSTM40.png}
    \caption{Delay Obtained in CMOSTM 40\degree}
    \label{fig:del_bit}
\end{figure}

The range in this simulation is 185 MHz to 263 MHz which would be enough to
generate the desired output frequency. It can be noted that the resolution is
probably better than needed and that the difference between some of the lower
bits is very small due to non-linearities. A possible solution would be to
``remove`` one bit from the system. This would probably also make it possible to
have a larger range and shift the centre of the interval closer to 250 MHz.
Because the system would be smaller it would also consume less power.

Testing the design in different process corners showed huge difference in
performance in the worst power and worst speed corners. The worst zero and worst
one corners showed no notable difference in range and resolution compared to typical
mean. For worst power it is possible to reduce the voltage of the separate delay
line VDD. Reducing it to 2.8 V resulted in a frequency range for the input signal
of approximately 250-370 MHz. For worst speed the voltage needs instead to be
increased. However, even when increasing the voltage the target input frequency
of 250MHz could not be reached. With a delay line VDD of 3.6 V the obtained
interval of the input was 150-200 MHz.   

\subsection{Lock Detector}
The most important aspect of the lock detector is the delay interval where
the lock signal goes low. In the figure below an average of the
output signal from different delays between when the input clock and the
360\degree delayed clock are shown. At 0 delay, the delay between the input
signals is of course 0, at -100 ps delay the 360\degree delayed clock comes 100 ps
before the reference clock and reverse at 100 ps. In figure
\ref{fig:LDtm} the interval for the typical mean can be seen. The interval 
is quite even and can lock when the difference between the reference
clock and the 360\degree delayed clock is approximately 80 ps. Corner simulations of the lock interval are presented in
appendix \ref{sec:corners}.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/LD_tran/LD_lsim_tm.png}
  \caption{Lock interval in typical mean}
  \label{fig:LDtm}
\end{figure}

\clearpage


\subsection{Frequency Multiplier}
To reach the wanted functionality the supply voltage and input frequency must be
adjusted in some of the corner variations. But with some tweaking a
multiplication of four can be reached in all the corners.

With the typical mean model library the frequency multiplier works for
input frequencies up to 285 MHz in simulations, in 40 \degree C with a supply
voltage of 3.3 V.

The maximum input frequency for different corners and temperatures can be seen
in table \ref{tab:freq_mult}.

When the input frequency is higher than the maximum the combined pulses will be
a constant zero and the output will not be valid. For high frequencies the
output will not reach full swing, even though the output driver is quite big.
This is because the capacitance of the pad and measurement equipment will be
relatively high. In the simulations a capacitance of 4 pF is used.

The result of a simulation can be seen in figure \ref{fig:freq_mult_sim} in appendix
\ref{sec:corners}.
\begin{table}[h]
        \centering
        \begin{tabular}{|c|c|c|c|}
                \hline
        \textbf{Corner} & \textbf{Temperature (\degree C)} &
        \textbf{Supply Voltage (V)} & \textbf{Max frequency(MHz)} \\
        \hline
        tm & 40 & 3.3 & 285 \\
        tm & 90 & 3.3 & 250 \\
        wp & 40 & 3.3 & 450 \\
        ws & 40 & 3.4 & 200 \\
        wz & 40 & 3.3 & 285 \\
        wo & 40 & 3.3 & 313 \\

        \hline
\end{tabular}
\caption{Maximum input frequency of frequency multipliers}
\label{tab:freq_mult}
\end{table}

\newpage
\section{Evaluation Plan and PAD List}

\begin{figure} [h!]
\centering
\includegraphics[width=0.6\textwidth]{../Bilder/Layout/PCB.png}
\caption{PCB layout}
\label{fig:PCB}
\end{figure}

\begin{table} [h!]
\begin{tabular}{l  l  l  l}
Pin number & Name & Type & Connection\\ \hline \\
1 & VDD			& VDD				& Power Supply	\\
2 & VDD\_MULT	& VDD				& Power Supply	\\
3 & OUT			& Clock Output		& SMA			\\
4 & 360\_DEL	& Clock Output		& SMA			\\
5 & UPDOWN		& Digital Output	& Pin Array		\\
6 & VSS			& Ground			& Ground		\\
7 & VDD\_BUF	& VDD				& Power Supply	\\
8 & LOCK		& Digital Output	& Pin Array		\\
9 & IN\_OUT		& Clock output		& SMA			\\
10 & VDD\_DELAY	& VDD				& Power Supply	\\
11 & RESET		& Digital Input		& Push Button	\\
12 & CLK		& Clock Input		& SMA
\end{tabular}
\caption{PCB table}
\label{tab:PCB}
\end{table}

\subsection{Testing of the System}
% Hur ska chippet testas?
The testing will be done for different input clock frequencies
, with varying settings of voltage levels for the sub-systems. The
signals we are most interested in are the signals 3, 4, 5, 8 and 9
from Table \ref{tab:PCB}. The testing will be done using an oscilloscope.


\section{Risks}
% Vad kan gå fel
In this section the risks of the design is discussed. The risks will mainly be
about the process variations during fabrication. There is also the risk that,
even though the current densities of the wires were tested, somehow a node was
overlooked and will see a current that is too high.

\subsection{Phase Detector}
One of the biggest risks concerning the PD is when we get
slow/slow transistors, since the PD is used both as a stand-alone
module, and within the lock detector.

\subsection{Counter}
As the Counter is used to control the delay line, the speed and timing is not as
big an issue as in the case of the other parts. The only issue that has occurred
is that of the timing of the carry propagation signal and the inputs. When the
transistor level Counter was tested, the input signals did not have to be
clocked. In the layout this resulted in glitches where the upper bits acted as
if the counter was counting up while the lower bits counted down as the input
signals indicated. This problem occurred when the input signals switched too
close in time to the switching of the clock. In this design the problem is
solved by sampling the input signals through DFFs, but it can be easily
overlooked as the signals appear to be sampled by the same clock if the
parasitic capacitances of the wires, and the delays induced by these, are
overlooked. The carry propagation is the critical path of the Counter and
therefore determines the maximum frequency at which it can operate. As this
design has a 6-bit Counter the carry propagation path is quite long. Thus it is
important to size the transistors for maximum speed. 

\subsection{Digitally Controlled Delay Line}
The simulations of the delay line showed that process variation corners is a big
risk. In the worst speed case it is probably not possible to reach an output
frequency of 1 GHz. For worst power there should not be any real problem since
producing a little higher output frequency is not a bad thing. The only risk is
that the capacitance on the output will distort signals of higher frequencies.

\subsection{Lock Detector}
The main risk with the lock detector is if the lock signal goes low on a bad interval such that it causes the DLL output faulty signal.

% Bild på hur bra VS dåligt interval är

Related to this is also if it does not lock at all and thus is just a load on the chip. 
\subsection{Frequency Multiplier}

\section{Evaluation}
% Vad har vi lärt oss
We have learned a lot about how to layout hardware, specifically using cadence.
We also came to understand the theoretical parts taught during the lectures 
better when working on the project. The top-down design methodology is something 
we have used in previous courses, but using it to this extent has been really 
useful and educational. 

% Hur har gruppen fungerat
The group has worked well. This has got a lot to do with the
fact that we knew each other since before the course.

% Har tiden delats väl
The time has not been split fairly in the group, but this has
to do with the fact that some sub-blocks were a lot more time-consuming.
This could have been avoided, to some extent, had the responsibility
of the sub-blocks among the group-members been distributed differently.

% Vad var bra/dåligt
The lectures were really interesting and gave us a lot of
second-hand experience of the industry. The labs were really 
good and prepared us for the project in a well thought out fashion.

The lab manual was good, but the tasks to be done during the labs should 
be clearly written in bullet points. Another thing that should be added 
in the manual are ways and methods of decreasing the simulation time as well
as general hints when using cadence.

% Kommentarer till kursen
A really good course that was relevant to our studies.

\newpage
\appendix 
\newpage

\addcontentsline{toc}{section}{References}
\begin{thebibliography}{99}
        \bibitem{dll_clock}\textit{A Low-Power Digital DLL-Based Clock Generator in Open-Loop Mode - }
                Behzad Mesgarzadeh, Atila Alvandpour \\
                IEEE Journal of Solid-State Circuits. Vol. 44. No. 7. July 2009
        \bibitem{lock_detect}\textit{A 62.5-625-Mhz Anti-Reset All-Digital Delay-Locked Loop - }
                Shao-Ku Kao, Bo-Jiun Chen and Shen-Iuan Liu \\
                IEEE Transations on Circuits and Systems - II: Express Briefs, Vol. 54 No. 7, July 2007
        \bibitem{dll_report}\textit{DLL-Based Frequency Multiplier - }
                Layout Edition 2008-05-25 \\
        \bibitem{transistor}\textit{Transistor Level - }
                Bengtz, Berneland, Björklund, Hallberg, Svensk \\

\end{thebibliography}

\newpage
\section{Corner simulation results}
\label{sec:corners}

\begin{figure}[h]
        \centering
        \includegraphics[width=0.9\textwidth]{../Bilder/freq_mult_layout_sim.png}
        \caption{Simulation of frequency multiplier}
        \label{fig:freq_mult_sim}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/Layout/simulations/pd_tm.png}
  \caption{Set-up time of PD in typical mean}
  \label{fig:PDtm}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/Layout/simulations/pd_wo.png}
  \caption{Set-up time of PD in worst one}
  \label{fig:PDwo}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/Layout/simulations/pd_wz.png}
  \caption{Set-up time of PD in worst zero}
  \label{fig:PDwz}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/Layout/simulations/pd_wp.png}
  \caption{Set-up time of PD in worst power}
  \label{fig:PDwp}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/Layout/simulations/pd_ws.png}
  \caption{Set-up time of PD in worst slow}
  \label{fig:PDws}
\end{figure}


In figure \ref{fig:LDwp} to \ref{fig:LDws} the corner simulations for
the lock interval is shown.

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/LD_tran/LD_lsim_wp.png}
  \caption{Lock interval in worst power}
  \label{fig:LDwp}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/LD_tran/LD_lsim_wo.png}
  \caption{Lock interval in worst one}
  \label{fig:LDwo}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/LD_tran/LD_lsim_wz.png}
  \caption{Lock interval in worst zero}
  \label{fig:LDwz}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=0.65\textwidth]{../Bilder/LD_tran/LD_lsim_ws.png}
  \caption{Lock interval in worst slow}
  \label{fig:LDws}
\end{figure}

\section{Layout of sub-blocks}
\label{sec:Layout}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/pd_including_clk_set.png}
  \caption{PD layout}
  \label{fig:pd_final}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/lock_detector.png}
  \caption{Lock Detector layout}
  \label{fig:LD}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/bitcell.png}
  \caption{Bitcell layout}
  \label{fig:bitcell_final}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/dff_sync_reset_qbar_clkset.png}
  \caption{DFF layout}
  \label{fig:dff_final}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/ud_counter_6bit.png}
  \caption{UD counter layout}
  \label{fig:counter_final}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/delay_line_trans.png}
  \caption{Delay line layout}
  \label{fig:delay_final}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/freq_mult_tpl.png}
  \caption{Freqmult layout}
  \label{fig:freq_mult_final}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics[width=1.0\textwidth]{../Bilder/Layout/complete_system.png}
  \caption{Complete system layout}
  \label{fig:complete_system_final}
\end{figure}

\end{document} 
% Local Variables: %%% mode: latex %%% TeX-master: t %%% End:
